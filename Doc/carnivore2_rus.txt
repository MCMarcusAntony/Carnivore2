Спецификация Carnivore2 MultiFunctional Cartridge
Copyright (c) 2017-2018 by RBSC
Русская версия
Последнее обновление - 17.05.2018
-------------------------------------------------

Расположение блоков в флеш чипе
-------------------------------

В начале флэш чипа расположены бут блок, директория и биосы встроенных устройств. Ниже приведено их расположение
по блокам. Следует различать физические и логические блоки.


8-килобайтные блоки
-------------------

Первые 8 физических блоков флэш чипа соответствуют нулевому логическому блоку регистра AddrFR. Блоки 0 и 1 содежат
код бут блока с меню

 - 000000h-001FFFh (блок 0) - после включения питания (AddrFR=#00, R1Mult="10000101" B1AdrD = #4000) отображается в
   Subslot 0 по адресу #4000-#5FFF и содержит бут блок (заголовок ROM картриджа "AB" + адреса старта)
 - 002000h-003FFFh (блок 1) - после включения питание отображается в Subslot 0 по адресу #6000-#7FFF (биты 2-0 регистра
   R1Mult = "101" означают размер отображаемого блока (картриджа) 16кб и состоят из двух физических 8кб блоков

Блоки 2 и 3 содержат записи директории

 - 004000h-005FFFh (блок 2)
 - 006000h-007FFFh (блок 3)

Блок 4 - таблица "автостарта"

 - 008000h-009FFFh (блок 4) - этот блок содержит таблицу "Autostart"; чтобы не записывать переменную автостарта по одному
   физическому байту, она последовательно перемещается по всему блоку

Блоки 5, 6 и 7 не используются

 - 00A000h-00BFFFh (блок 5)
 - 00C000h-00DFFFh (блок 6)
 - 00E000h-00FFFFh (блок 7)


64-килобайтные блоки
--------------------

После первых восьми 8кб блоков начинаются 64-и килобайтные физические блоки флеш чипа.

Физические блоки 8 и 9 (соответствуют логическим блокам 1 и 2) содержат BIOS контроллера IDE

 - 010000h-01FFFFh (блок 8, логический блок 1, AddrFR=#01)
 - 020000h-02FFFFh (блок 9, логический блок 2, AddrFR=#02)

Физический блок 10 (соответствуют логическому блоку 3) содержит FMPAC BIOS

 - 030000h-03FFFFh (блок 10, логический блок 3, AddrFR=#03)


Блоки данных
------------

Далее начинаются 64 килобайтные физические блоки флеш чипа, отданные для загрузки пользовательских ROM образов (игр).

 - 040000h-04FFFFh (блок 11, логический блок 4, AddrFR=#03)
 - 050000h-05FFFFh (блок 12, логический блок 5, AddrFR=#03)
...
...
 - 7F0000h-7FFFFFh (блок 134, логический блок 127, AddrFR=#7F)


Регистры конфигурации
---------------------

Регистры конфигурации и управления начинаются с адреса 0F80h или 4F80h или 8F80h или СF80h или.. 
или нигде не начинаются а тихо прячутся. Всё зависит от того что записано в "нулевом" управляющем регистре
после включения питания инициализируются на адрес 4F80h. Все регистры доступны только для записи за ислкючением
псевдорегистра для прямого доступа к FlashROM или к конфигурационному EEPROM.

+00 CardMDR регистр управления конфигурацией картриджа

    7 бит = 1- запрет отображения регистров, 0- регистры отображаются
    6,5 биты = 0/1/2/3 - регистры отображаются начиная с адреса 0F80h/4F80h/8F80h/CF80h
    4 бит = 1- разрешение "чипа" SCC, 0- запрет
    3 бит = 1- режим отложенной конфигурации, 0- конфигурация меняется сразу после изменения управляющих регистров
    2 бит = 0- при отложенной конфигурации изменения вступают в силу после выполнения процессором команды с адреса 0000h
	  = 1- изменения вступают в силу после выполнения чтения с адреса 4000h
               отложенная конфигурация регистров действует только для AddrFR и регистров управления банками
    1 бит - данные для чтения BIOS встроенных устройств
            0 - данные системных ROM образов (бутблок, IDE контроллер, FMPAС) читаются из флеш чипа
            1 - данные системных ROM образов (бутблок, IDE контроллер, FMPAС) читаются из RAM чипа картриджа
                (внимание! предварительно данные нужно перезписать из флеш в RAM)
    0 бит - управление чтеним служебных регистров  
		0 - все служебные регистры читаются по сотвествущим адресам памяти согласно битам 6,5 в 0F80h/4F80h/8F80h/CF80h
		1 - служебные регистры не читаются, отображается только 1 байт данных флеш блока согласно установленым
                значениям регистров банка

+01 AddrM0 - младший регистр адреса (7..0) для обращения к FlashROM

+02 AddrM1 - средний регистр адреса (15..8) для обращения к FlashROM

+03 AddrM2 - старший регистр адреса (22..16) для обращения к FlashROM

+04 DatM0  - псевдорегистр для передачи данных FlashRОM

+05 AddrFR - регистр номера блока FlashROM с которого будут читатся данные для эмуляции ROM (размер блока 64кб)
             начальная конфигурация 00h

Регистры конфигурации первого банка
-----------------------------------

+06 R1Mask - маска для адреса регистра страницы банка (этот регистр как правило дублируется на несколько адресов
             например для картриджа Konami 5 (SCC) эти адреса для первого банка  5000h-57FFh, здесь задаётся 
             маска только старшего байта  - 11111000b или F8h

    начальная конфигурация F8h

+07 R1Addr - адрес регистра страницы банка, старший байт для адреса 5000h это 50h
    начальная конфигурация 50h

+08 R1Reg  - содержимое регистра страницы банка, здесь задаётся начальное значение странцы перед запуском 
             содержимого ROM как правило = 00h

    начальная конфигурация 00h

+09 R1Mult - регистр режима банка и его размера

    7 бит = 1 - разрешение регистра страницы банка, 0 - управление страницой банка выключено
    6 бит = 1 - зеркалирование выключено, 0 - включено
    5 бит = 0 - выбор в качестве источника FlashROM, 1 - RAM
    4 бит = 1 - разрешение записи в банк, 0 - запрет записи в банк
    3 бит = 0 - банк включен, 1 банк выключен 
    2,1,0 биты - размер банка 111b = 64 Кбайт, 110b = 32 Кбайт, 101b = 16 Кбайт, 100b = 8 Кбайт, 011b = 4 Кбайт
            остальные значения - банк выключен

    начальная конфигурация - 85h        

+0A B1MaskR- Маска для адресации банка в блок FlashROM (размер эмулируемой ROM или количество страничек, например
             для 128 кб ROM нужно 16 страничек по 8 Кб, значит выбираем маску = 0Fh или 00001111b)
	     начальная когфигурация - 03h

+0B B1AdrD - Адрес банка, только старший байт.. для 4000h = 40h
             начальная конфигуарция - 40h


Регистры конфигурации второго банка
-----------------------------------

+0C R2Mask
+0D R2Addr
+0E R2Reg
+0F R2Mult   начальное значение - 00h, банк выключен
+10 B2MaskR
+11 B2AdrD
             
Регистры конфигурации третьего банка
------------------------------------

+12 R3Mask
+13 R3Addr
+14 R3Reg
+15 R3Mult   начальное значение - 00h, банк выключен
+16 B3MaskR
+17 B3AdrD

Регистры конфигурации четвёртого банка
--------------------------------------

+18 R4Mask
+19 R4Addr
+1A R4Reg
+1B R4Mult   начальное значение - 00h, банк выключен
+1C B4MaskR
+1D B4AdrD


+1E Mconf мультикартридж конфигурация, расширенный слот
    7 бит = 1 - разрешение расширенного слота  0 - один слот
    6 бит = 1 - разрешение чтения портов МММ-маппера FC,FD,FE,FF
    5 бит = 1 - разрешение YM2413 (FM Pack Synt. 7Ch,7Dh)
    4 бит = 1 - разрешение 3С порта (МММ-маппера)
    3 бит = 1 - разрешение -3 сабслота FM Pack bios ROM
    2 бит = 1 - разрешение -2 сабслота 1 Mb RAM с маппером (MMM стандарт)
    1 бит = 1 - разрешение -1 сабслота CF card интерфейс
    0 бит = 1 - разрешение -0 сабслота MSCC (и данного регистра)

+1F CMDRCpy - дубль регистра управления CardMDR (для использования команды LDIR)

+20 ConfFl -  регистр конфигурации чипа FlashROM

    2 бит = 0 для 8 разрядной шины данных, = 1 для 16 разрядной шины данных
    1 бит = Reset/protect flag
    0 бит = 1 = подать 12 вольт для режима скоростной записи, = 0 - запретить +12в 

    начальная конфигурация - 010b

+#21 NSReg - служебный регистр
     начальная конфигурация - #00, не меняйте его!

+#22 SndLVL - регистр уровня громкости для FMPAC и SCC

    7,6 биты	- не используется
    5,4,3 биты	- уровень аудио с FM-PAK модуля (0-7)
    2,1,0 биты	- уровень аудио с SCC(SCC+) модуля (0-7)

    начальная конфигурация - 1Bh (00011011b) по включению питания; аппаратный рестарт не влияет

+#23 CfgEEPR - управление конфигурационным ППЗУ 93С46 (чтение и запись байтов конфигурации)

    7,6,5,4 биты - не используется
    3 бит	- EECS сигнал Chip Select EEPROM
    2 бит	- EECK сигнал CLK (синхро)
    1 бит	- EEDI сигнал Data Input (данные подаваемые на EEPROM)
    0 бит	- EEDO сигнал Data Output (данные выдаваемые с EEPROM); только чтение	

+#24 PSGCtrl - регистр управления встроенным PSG

    7 бит	- включение/выключение PSG
    6 бит	- включение/выключение PPI Clicker
    5,4,3 биты	- уровень аудио с PSG модуля (0-7)
    2,1,0 биты	- уровень аудио с PPI Clicker (0-7)

    начальная конфигурация - 1Bh (00011011b) по включению питания; аппаратный рестарт не влияет

+#25 V_AR_L	- младшие 8 бит адреса кода перехватчика
+#26 V_AR_H	- старшие 8 бит адреса кода перехватчика

+#27 aV_hunt	- конфигурация перехватчика для режима отложенной конфигурации
    0 бит = включение перехватчика по рестарту системы или по чтению с адреса #4000; 1 = включён
    1 бит = расположение перехватчика; 0 = бутблок в FlashRОM, 1 = нулевой блок скрытого ОЗУ


Формат записи директории
------------------------

[00] ACT - Флаг активности записи (FF - пустая запись)
[01] PSV - Пассивная запись (FF - не пассивная)
[02] STB - Стартовый блок 
[03] LNB - Длина в блоках

        Будущий вариант			|    Текущий вариант
                                  	|     
 [04,05,06,07,08,09,0A,0B] Имя файлы   	| [04] - Тип маппера записи
 [0C,0D,0E] Расширение			| [05 - 22] Текст (имя записи - 30 символов)
 [0F] REZ - Резерв			|
 [10 - 22] Текст (19 байт)		|

[23 24 25 26 27 28] R1Mask R1Addr R1Reg R1Mult B1MaskR B1AdrD - 6 байт конфигурации первого банка
[29 2A 2B 2C 2D 2E] R2Mask R2Addr R2Reg R2Mult B2MaskR B2AdrD - 6 байт конфигурации второго банка
[2F 30 31 32 33 34] R3Mask R3Addr R3Reg R3Mult B3MaskR B3AdrD - 6 байт конфигурации третьего банка
[35 36 37 38 39 3A] R4Mask R4Addr R4Reg R4Mult B4MaskR B4AdrD - 6 байт конфигурации четвёртого банка

[3B] Mconf - конфигурация расширенного слота

[3C] CardMDR - регистр конфигурации картриджа

[3D] PosSiz размер и позиция мини РОМа в 64кб блоке

    Бит 7 - резерв
    Биты 6,5,4 - смещение мини РОМа в 64кб блоке в зависимости от длины ROM файла
                8 кб  16 кб  32 кб
        --------------------------
	000b =  0 кб   0 кб   0 кб
	001b =  8 кб  16 кб  32 кб
	010b = 16 кб  32 кб
	011b = 24 кб  48 кб
	100b = 32 кб
	101b = 40 кб
	110b = 48 кб
	111b = 56 кб
    Бит 3 - нестандартный размера мини РОМа
	1 - 49 кб
	0 - другой размер
    Биты 2,1,0 - размер мини РОМа
	110b = 32 кб
	101b = 16 кб
	100b = 8 кб
	011b = 4 кб
	000b = не является мини РОМом

[3E] RstRun - флаги перезагрузки и выбора стартового адреса для РОМа

	Бит 0 = 0 - не перезагружать MSX; 1 - перезагрузить MSX
	Бит 1 = 0 - не запускать ROM; 1 - запустить ROM используя ROMini адрес (биты 2,3)
	Бит 2 = 0 - запустить использовать адрес запуска из 4002h; 1 - использовать адрес запуска из 8002h
	Бит 3 = 0 - использовать бит 2 из этого регистра; 1 - использовать адрес запуска из 0002h

[3F] Resrv - Резерв


Адреса записи специальных значений в конфигурационной ППЗУ
----------------------------------------------------------

[01] - громкость FMPAC и SCC. По 3 бита на громкость, максимальное значение - 8. Первые 2 бита используются как признак того,
       что громкость была предварительно записана в ППЗУ

[02] - флаг 50 или 60 Гц развёртки для видеопроцессора. Бит 1 в этом байте - сам флаг. Если бит в нуле, то используется 60 Гц

[03] - флаги включения/выключения PSG и PPI Clicker, а также их громкость. По 3 бита на громкость, максимальное значение - 8.
       Первые 2 бита используются для включения и выключения PSG и Clicker
